plugins {
    id 'java'
    id 'com.github.johnrengelman.shadow' version '7.1.2'
}

group = 'com.ikingsnipe'
version = '13.0.0-MASTER'

// Java 8 compatibility for DreamBot
java {
    sourceCompatibility = JavaVersion.VERSION_1_8
    targetCompatibility = JavaVersion.VERSION_1_8
}

repositories {
    mavenCentral()
    maven { url 'https://m2.dv8tion.net/releases' }
}

dependencies {
    // DreamBot API (provided by DreamBot client)
    compileOnly fileTree(dir: 'libs', include: ['dreambot-*.jar'])
    
    // Discord JDA (Java 8 compatible version)
    implementation('net.dv8tion:JDA:4.4.0_352') {
        exclude module: 'opus-java'
    }
    
    // Database - HikariCP connection pooling (Java 8 compatible version)
    implementation 'com.zaxxer:HikariCP:3.4.5'
    implementation 'mysql:mysql-connector-java:8.0.33'
    
    // JSON processing
    implementation 'com.google.code.gson:gson:2.10.1'
    
    // Logging (Java 8 compatible)
    implementation 'org.slf4j:slf4j-api:1.7.36'
    implementation 'org.slf4j:slf4j-simple:1.7.36'
    
    // Utilities
    implementation 'commons-codec:commons-codec:1.15'
}

tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
    options.compilerArgs += ['-Xlint:deprecation', '-Xlint:unchecked']
}

shadowJar {
    archiveFileName = 'iKingSnipe-Master-v13.jar'
    archiveClassifier = ''
    
    // Relocate dependencies to avoid conflicts with other scripts or DreamBot
    relocate 'com.google.gson', 'com.ikingsnipe.libs.gson'
    relocate 'com.mysql', 'com.ikingsnipe.libs.mysql'
    relocate 'com.zaxxer.hikari', 'com.ikingsnipe.libs.hikari'
    relocate 'net.dv8tion.jda', 'com.ikingsnipe.libs.jda'
    relocate 'org.slf4j', 'com.ikingsnipe.libs.slf4j'
    relocate 'org.apache.commons', 'com.ikingsnipe.libs.commons'
    
    // Exclude signature files to avoid security exceptions
    exclude 'META-INF/*.SF'
    exclude 'META-INF/*.DSA'
    exclude 'META-INF/*.RSA'
    
    mergeServiceFiles()
    
    manifest {
        attributes(
            'Main-Class': 'com.ikingsnipe.core.BotApplication',
            'Implementation-Title': 'iKingSnipe Elite Casino',
            'Implementation-Version': project.version,
            'Multi-Release': 'true'
        )
    }
}

clean {
    delete 'build'
}

defaultTasks 'clean', 'shadowJar'
