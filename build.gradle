buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath 'com.guardsquare:proguard-gradle:7.3.2'
    }
}

plugins {
    id 'java'
    id 'com.github.johnrengelman.shadow' version '7.1.2'
}

group = 'com.ikingsnipe'
version = '14.0.0-GOATGANG'

java {
    sourceCompatibility = JavaVersion.VERSION_1_8
    targetCompatibility = JavaVersion.VERSION_1_8
}

repositories {
    mavenCentral()
    maven { url 'https://m2.dv8tion.net/releases' }
}

dependencies {
    compileOnly fileTree(dir: 'libs', include: ['dreambot-*.jar'])
    implementation('net.dv8tion:JDA:4.4.0_352') { exclude module: 'opus-java' }
    implementation 'com.zaxxer:HikariCP:4.0.3'
    implementation 'mysql:mysql-connector-java:8.0.33'
    implementation 'com.google.code.gson:gson:2.10.1'
    implementation 'org.slf4j:slf4j-api:1.7.36'
    implementation 'org.slf4j:slf4j-simple:1.7.36'
    implementation 'commons-codec:commons-codec:1.15'
}

tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
    options.compilerArgs += ['-Xlint:deprecation', '-Xlint:unchecked']
}

shadowJar {
    archiveFileName = 'ikingsnipe-14.0.0-GOATGANG.jar'
    archiveClassifier = ''
    
    relocate 'com.google.gson', 'com.ikingsnipe.libs.gson'
    relocate 'com.zaxxer.hikari', 'com.ikingsnipe.libs.hikari'
    relocate 'org.slf4j', 'com.ikingsnipe.libs.slf4j'
    relocate 'net.dv8tion.jda', 'com.ikingsnipe.libs.jda'
    relocate 'org.apache.commons', 'com.ikingsnipe.libs.commons'
    
    exclude 'META-INF/*.SF'
    exclude 'META-INF/*.DSA'
    exclude 'META-INF/*.RSA'
    
    mergeServiceFiles()
    
    manifest {
        attributes(
            'Main-Class': 'com.ikingsnipe.core.BotApplication',
            'Implementation-Title': 'GoatGang Edition by iKingSnipe',
            'Implementation-Version': project.version,
            'Multi-Release': 'true'
        )
    }
}

task obfuscate(type: proguard.gradle.ProGuardTask, dependsOn: shadowJar) {
    configuration 'proguard.txt'
    
    injars "build/libs/iKingSnipe-GoatGang-v14.0.jar"
    outjars "build/libs/iKingSnipe-GoatGang-v14.0-Protected.jar"
    
    // Use the current Java home for library jars
    def javaHome = System.getProperty('java.home')
    if (new File("${javaHome}/lib/rt.jar").exists()) {
        libraryjars "${javaHome}/lib/rt.jar"
        libraryjars "${javaHome}/lib/jce.jar"
    } else {
        // For Java 9+
        libraryjars "${javaHome}/jmods/java.base.jmod", jarfilter: '!**.jar', filter: '!module-info.class'
        libraryjars "${javaHome}/jmods/java.desktop.jmod", jarfilter: '!**.jar', filter: '!module-info.class'
    }
    
    configurations.compileClasspath.each { libraryjars it }
}

clean {
    delete 'build'
}

defaultTasks 'clean', 'shadowJar'
